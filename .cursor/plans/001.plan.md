<!-- 734cf503-af5f-42da-91fc-7b9622270b6c 82ceda6f-ac7c-470c-9c75-12a5794c17d7 -->
# 第一阶段：知识库构建实施计划

## 目标

实现知识库构建的完整流程，将小说章节文件处理并存储到向量数据库中，为后续的问答查询做好准备。

## 实施步骤

### 1. 创建项目配置文件

**文件**: `config/settings.yaml`

- 配置嵌入模型路径（BGE-M3）
- 配置向量数据库路径（Chroma）
- 配置数据源路径（data/raw/）
- 配置文本分割参数（chunk_size, chunk_overlap等）
- 配置设备选择（cuda/cpu）

### 2. 实现文档加载模块

**文件**: `src/knowledge_base/document_loader.py`

- 实现`DocumentLoader`类
- 支持加载TXT格式文件（当前已有章节文件）
- 支持批量加载目录中的所有TXT文件
- 返回文档对象列表，包含文本内容和元数据（文件名、章节号等）

### 3. 实现文本分割模块

**文件**: `src/knowledge_base/text_splitter.py`

- 实现`TextSplitter`类
- 优先按章节分割（利用文件名中的章节信息）
- 对于超长章节，实现滑动窗口分割
- 支持可配置的chunk_size和chunk_overlap参数
- 保留章节信息作为元数据

### 4. 实现嵌入模型封装

**文件**: `src/llm/embedder.py`

- 实现`Embedder`类
- 封装BGE-M3
- 支持批量向量化
- 支持GPU/CPU设备选择
- 提供向量维度信息

### 5. 实现向量数据库操作

**文件**: `src/knowledge_base/vector_store.py`

- 实现`VectorStore`类
- 使用Chroma作为向量数据库
- 实现创建、保存、加载向量数据库的方法
- 存储文本片段、向量和元数据（章节号、文件名等）
- 支持持久化到`storage/vector_db/`目录

### 6. 创建知识库构建脚本

**文件**: `build_kb.py`

- 整合所有模块，实现完整的知识库构建流程
- 命令行参数支持（数据源路径、配置文件路径等）
- 显示构建进度和统计信息
- 错误处理和日志记录

### 7. 更新依赖文件

**文件**: `requirements.txt`

- 添加必要的Python包：
- `chromadb` - 向量数据库
- `sentence-transformers` 或 `transformers` - 嵌入模型
- `pyyaml` - 配置文件解析
- `torch` - 深度学习框架（如果使用本地模型）

### 8. 创建必要的__init__.py文件

- `src/__init__.py`
- `src/knowledge_base/__init__.py`
- `src/llm/__init__.py`

## 技术选型确认

- **嵌入模型**: BGE-M3（通过ollama）
- **向量数据库**: Chroma（轻量级，易于使用）
- **文本分割**: 按章节分割 + 滑动窗口（超长章节）
- **配置管理**: YAML文件

## 关键实现细节

1. 文档加载时，从文件名提取章节号（如"第1000章_阵容.txt"）
2. 文本分割保留章节边界，避免跨章节分割
3. 向量化支持批量处理以提高效率
4. 向量数据库存储时，保留章节号和文件名等元数据，便于后续引用
5. 构建脚本提供清晰的进度反馈和错误提示

### To-dos

- [ ] 创建config/settings.yaml配置文件，包含嵌入模型、向量数据库、数据源路径等配置项
- [ ] 实现src/knowledge_base/document_loader.py，支持加载TXT文件并提取章节信息
- [ ] 实现src/knowledge_base/text_splitter.py，实现按章节分割和滑动窗口分割
- [ ] 实现src/llm/embedder.py，封装BGE-M3嵌入模型，支持批量向量化
- [ ] 实现src/knowledge_base/vector_store.py，使用Chroma实现向量数据库的创建、保存和加载
- [ ] 创建build_kb.py脚本，整合所有模块实现完整的知识库构建流程
- [ ] 更新requirements.txt，添加chromadb、sentence-transformers、pyyaml等依赖
- [ ] 创建必要的__init__.py文件，使模块可以正确导入